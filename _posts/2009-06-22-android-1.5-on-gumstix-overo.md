---
author: 歐巴計概
date: 2009-06-22 03:31:00.009000+00:00
layout: post
permalink: /2009/06/android-15-on-gumstix-overo.html
title: android 1.5 on gumstix overo
---

kernel source可從 [embinux.org](http://labs.embinux.org/index.php/Android_Porting_Guide_to_Beagle_Board) 取得，其中也包含android 1.5的source code，並且有做一些patch

ex: battery, and keyboard layout

**Download and Compile Source**

> $ mkdir your\_android\_dir
>
> $ cd your\_android\_dir
>
> $ repo init -u git://labs.embinux.org/repo/android/platform/beaglemanifest.git/
>
> $ repo sync
>
> $ make
>
> ps: 關於repo，參考<http://source.android.com/download>的Installing Repo

**Compile kernel**

> $ cd your\_android\_dir/kernel
>
> $ export CC\_PATH=/home/vanix/CodeSourcery/Sourcery\_G++\_Lite/bin/arm-none-linux-gnueabi-
>
> $ make menuconfig
>
> 由於板子的關係，額外勾選gumstix overo and USB host
>
> $ vi ../vendor/embinux/support-tools/beagle\_build\_kernel.sh
>
> comment the codes about make config and make clean
>
> $ ../vendor/embinux/support-tools/beagle\_build\_kernel.sh
>
> 此時只會build，不會刪除剛設定好的.config

**Install Android Root Filesystem into SD Card**

> $ cd your\_android\_dir/out/target/product/generic
>
> $ cp -a root/\* /media/disk/
>
> $ cp -a system/\* /media/disk/system/
>
> $ cd /media/disk/
>
> $ chown -R root.root \*
>
> $ chmod -R 777 data/ system/
>
> ps: 要注意init.rc的mount ro xxx此行是否有註解掉

**Boot arguments**

> ~~$ setenv mmcargs setenv bootargs console=ttyS2,115200n8 root=/dev/mmcblk0p2 rootdelay=2 omapfb.mode=dvi:800x480MR-16@60 init=/init~~
>
> $ setenv mmcargs setenv bootargs console=ttyS2,115200n8 androidboot.console=ttyS2 root=/dev/mmcblk0p2 rootdelay=2 omapfb.mode=dvi:800x480MR-16@60 init=/init
>
> dss參數的寫法時常有變動，可參考kernel內的Documentation/arm/OMAP/DSS

**Other Setting**

參考之前另一篇[android on gumstix overo](http://vanix.blogspot.com/2009/03/android-on-gumstix-overo.html)

**Other Problems**

1. 800x480 on OLED panel - 1. dss參數下正確即可 2. kernel要support GPIO and 開機時立即執行gpio shell
2. Battery - 開機後立即halt，[android porting discussion](http://groups.google.com/group/android-porting/browse_thread/thread/35c33445c7ee8ee4/be9ee503e7fa4647?lnk=gst&q=System+halted#be9ee503e7fa4647)有好幾種解法，其中之一的解法：更改的[com\_android\_server\_BatteryService.cpp](http://groups.google.com/group/android-porting/attach/6f234b7b85f68ddf/com_android_server_BatteryService.cpp?part=2)
3. touch功能 - 板子並無外接touch panel，導致一些apps無法正常運作，[android porting 相關discussion](http://groups.google.com/group/android-porting/browse_thread/thread/f13cb06a4bff0b95/4c245f087b816341?lnk=gst&q=notouch#4c245f087b816341)，修改frameworks/base/libs/utils/ResourceTypes.cpp
4. 取出android SDK 1.5的file system - 參考[Extract google android file system image](http://discuz-android.blogspot.com/2008/01/extract-google-android-file-system.html)
5. 用android SDK 1.5 fs裡的system/，取代我們編譯好的system/，但是會遭遇上述2跟3的問題，將自己編好的libandroid\_servers.so和libutils.so取代原本的檔案即可解決

**Alsa Setting**

這個部份查到的資料比較繁瑣，另外獨立出來整理

Kernel的部份

> $ make menuconfig
>
> Device driver -> sound driver -> alsa -> 將相關的選項都打勾
>
> $ make
>
> $ cp arch/arm/boot/uImage /media/FAT

Android source的部份

> $ cd your\_android\_dir/external
>
> $ git clone git://android.git.kernel.org/platform/external/alsa-lib.git
>
> $ git clone git://android.git.kernel.org/platform/external/alsa-utils.git
>
> $
cd your\_android\_dir/hardware
>
> $ git clone git://android.git.kernel.org/platform/hardware/alsa\_sound.git
>
> $ vi your\_android\_dir/build/target/board/generic/BoardConfig.mk
BOARD\_USES\_ALSA\_AUDIO := true
>
> BUILD\_WITH\_ALSA\_UTILS=true
>
> # BOARD\_USES\_GENERIC\_AUDIO := true
>
> $ vi your\_android\_dir/system/core/init/devices.c
>
> { "/dev/snd/", 0664, AID\_SYSTEM, AID\_AUDIO, 1 },
>
> (事後發現這行似乎沒有作用, 還是得自行mkdir /dev/snd, 可參考init.rc)
>
> $ cd your\_android\_dir
>
> $ make
>
> $ vi your\_android\_dir/out/target/product/generic/root/init.rc
>
> # set the alsa audio driver
>
> mkdir /dev/snd
>
> symlink /dev/pcmC0D0c /dev/snd/pcmC0D0c
>
> symlink /dev/pcmC0D0p /dev/snd/pcmC0D0p
>
> symlink /dev/controlC0 /dev/snd/controlC0
>
> symlink /dev/timer /dev/snd/timer
>
> chmod 0777 /dev/snd/pcmC0D0c
>
> chmod 0777 /dev/snd/pcmC0D0p
>
> chmod 0777 /dev/snd/controlC0
>
> chmod 0777 /dev/snd/timer
>
> chown root audio /dev/snd/controlC0
>
> chown root audio /dev/snd/pcmC0D0c
>
> chown root audio /dev/snd/pcmC0D0p
>
> chown root audio /dev/snd/timer
>
> setprop alsa.mixer.playback.master Front
>
> setprop alsa.mixer.capture.master Capture
>
> setprop alsa.mixer.playback.earpiece Master
>
> setprop alsa.mixer.capture.earpiece Capture
>
> setprop alsa.mixer.playback.headset Master
>
> setprop alsa.mixer.playback.speaker
>
> $ vi your\_android\_dir/system/etc/asound.conf
>
> sample: [asound.conf](http://docs.google.com/View?id=dfkx5km7_18fq9fqrc2) for TWL4030 on OMAP
>
> (reference this [discussion](http://groups.google.com/group/android-porting/browse_thread/thread/b82e3d087fb33921/a1f8430acbba1368?q=twl4030&lnk=ol&) from android porting)